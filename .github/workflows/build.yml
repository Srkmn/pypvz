name: Build  

concurrency:   
  group: ${{ github.workflow }}-${{ github.ref }}  
  cancel-in-progress: true  

on:  
  push:  
    branches:  
      - master  # æ‚¨å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ä¸ºæ‚¨çš„ä¸»åˆ†æ”¯åç§°  

jobs:  
  windows:  
    runs-on: windows-latest  
    strategy:  
      fail-fast: false  
      matrix:  
        python_version:  
            - "3.11"  
    name: Windows Python ${{ matrix.python_version }}  
    steps:  
      - uses: actions/checkout@v2  

      - uses: ilammy/msvc-dev-cmd@v1  

      - name: Use Python ${{ matrix.python_version }}  
        uses: actions/setup-python@v2  
        with:  
          python-version: ${{ matrix.python_version }}  

      - name: ðŸ§³ Install dependencies  
        run: |  
          pip install --no-python-version-warning --disable-pip-version-check nuitka  
          pip install --no-python-version-warning --disable-pip-version-check zstandard  
          pip install --no-python-version-warning --disable-pip-version-check pygame  
          pip install --no-python-version-warning --disable-pip-version-check ordered-set  

      # ä½¿ç”¨Nuitkaæž„å»º  
      - name: Show nuitka version  
        run: |  
          python -m nuitka --version  

      - name: Create build script  
        run: |  
          @echo off > build.bat  
          echo python -m nuitka --standalone >> build.bat  
          echo     --onefile >> build.bat  
          echo     --show-progress >> build.bat  
          echo     --show-memory >> build.bat  
          echo     --output-dir=out >> build.bat  
          echo     --windows-icon-from-ico=pypvz.ico >> build.bat  
          echo     --include-data-file=c:\hostedtoolcache\windows\python\${{ matrix.python_version }}*\x64\lib\site-packages\pygame\libogg-0.dll=libogg-0.dll >> build.bat  
          echo     --include-data-file=c:\hostedtoolcache\windows\python\${{ matrix.python_version }}*\x64\lib\site-packages\pygame\libopus-0.dll=libopus-0.dll >> build.bat  
          echo     --include-data-file=c:\hostedtoolcache\windows\python\${{ matrix.python_version }}*\x64\lib\site-packages\pygame\libopusfile-0.dll=libopusfile-0.dll >> build.bat  
          echo     --include-data-file=c:\hostedtoolcache\windows\python\${{ matrix.python_version }}*\x64\lib\site-packages\pygame\libjpeg-9.dll=libjpeg-9.dll >> build.bat  
          echo     --include-data-dir=resources=resources >> build.bat  
          echo     --windows-disable-console >> build.bat  
          echo     -o pypvz-with-python${{ matrix.python_version }}-nuitka-windows-x64.exe >> build.bat  
          echo     pypvz.py >> build.bat  

      - name: Build pypvz with Nuitka  
        shell: cmd  
        run: build.bat  

      - name: Release the version built by nuitka  
        uses: ncipollo/release-action@v1  
        with:  
          allowUpdates: true  
          tag: Latest  
          artifacts: "./*.exe"  # ä¿®æ”¹äº†æ–‡ä»¶è·¯å¾„  
          body: |  
            ## è‡ªåŠ¨æž„å»ºç‰ˆæœ¬  
            
            è¿™æ˜¯ç”± GitHub Actions è‡ªåŠ¨æž„å»ºçš„æœ€æ–° Windows ç‰ˆæœ¬ã€‚  
            - æž„å»ºå·¥å…·: Nuitka  
            - Pythonç‰ˆæœ¬: ${{ matrix.python_version }}  
            - æž„å»ºæ—¶é—´: ${{ github.event.repository.updated_at }}  
          token: ${{ secrets.GITHUB_TOKEN }}  